<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BÃ¼cher-Serien Experte</title>
  <style>
    /* Dein bestehendes CSS bleibt erhalten - nur diese ErgÃ¤nzungen: */
    .serien-gruppe {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    .serien-header {
      background: #3498db;
      color: white;
      padding: 12px 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .serien-titel {
      font-weight: bold;
      font-size: 1.1em;
    }
    .serien-info {
      font-size: 0.9em;
      opacity: 0.8;
    }
    .lese-reihenfolge {
      background: #f8f9fa;
      padding: 10px;
      font-size: 0.9em;
      border-bottom: 1px dashed #ddd;
    }
    .buch-item {
      border-bottom: 1px solid #eee;
    }
    .buch-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <!-- Dein bestehendes HTML bleibt gleich bis auf diesen neuen Button: -->
  <div class="controls">
    <button id="sortNewest" class="sort-btn active">Neueste</button>
    <button id="sortOldest" class="sort-btn">Ã„lteste</button>
    <button id="showSeries" class="sort-btn">Serien anzeigen</button>
  </div>

  <script>
    // Neue Funktionen fÃ¼r Serienanalyse:
    function detectSeries(books) {
      const seriesMap = {};
      
      // Erkenne Serien durch Titelanalyse
      books.forEach(book => {
        // Erkenne gÃ¤ngige Serienmuster (Band, Teil, #, etc.)
        const serieInfo = extractSeriesInfo(book.titel);
        const serieKey = serieInfo ? serieInfo.name : 'EinzelbÃ¤nde';
        const bandNr = serieInfo ? serieInfo.number : 0;
        
        if (!seriesMap[serieKey]) {
          seriesMap[serieKey] = {
            books: [],
            guessedName: serieKey
          };
        }
        
        seriesMap[serieKey].books.push({
          ...book,
          bandNr: bandNr
        });
      });
      
      // Sortiere BÃ¼cher innerhalb der Serien nach Bandnummer
      Object.values(seriesMap).forEach(serie => {
        serie.books.sort((a, b) => a.bandNr - b.bandNr);
        
        // Verbessere den Seriennamen durch den hÃ¤ufigsten Titelteil
        if (serie.guessedName !== 'EinzelbÃ¤nde') {
          const commonPrefix = findCommonPrefix(serie.books.map(b => b.titel));
          if (commonPrefix.length > 10) { // Nur wenn sinnvoll
            serie.guessedName = commonPrefix;
          }
        }
      });
      
      return seriesMap;
    }

    function extractSeriesInfo(title) {
      // Erkenne verschiedene Serien-Formate
      const patterns = [
        /^(.*?)\s*\(Band\s*(\d+)\)/i,      // "Titel (Band 1)"
        /^(.*?)\s*[,-]\s*Band\s*(\d+)/i,    // "Titel - Band 1"
        /^(.*?)\s*Bd\.\s*(\d+)/i,           // "Titel Bd. 1"
        /^(.*?)\s*#(\d+)/i,                 // "Titel #1"
        /^(.*?)\s*Teil\s*(\d+)/i,           // "Titel Teil 1"
        /^(.*?)\s*Vol\.\s*(\d+)/i           // "Titel Vol. 1"
      ];
      
      for (const pattern of patterns) {
        const match = title.match(pattern);
        if (match) {
          return {
            name: match[1].trim(),
            number: parseInt(match[2])
          };
        }
      }
      return null;
    }

    function findCommonPrefix(titles) {
      if (titles.length === 0) return '';
      let prefix = titles[0];
      for (let i = 1; i < titles.length; i++) {
        while (titles[i].indexOf(prefix) !== 0) {
          prefix = prefix.substring(0, prefix.length - 1);
          if (prefix === '') return '';
        }
      }
      return prefix;
    }

    function displaySeries(seriesMap) {
      ergebnisListe.innerHTML = '';
      
      Object.entries(seriesMap).forEach(([serieKey, serie]) => {
        const serieElement = document.createElement('div');
        serieElement.className = 'serien-gruppe';
        
        let seriesHTML = `
          <div class="serien-header">
            <span class="serien-titel">${serie.guessedName}</span>
            <span class="serien-info">${serie.books.length} BÃ¼cher in der Serie</span>
          </div>
          <div class="lese-reihenfolge">
            ðŸ’¡ Lesereihenfolge: ${serie.books.map((b, idx) => 
              `${idx+1}. ${b.titel.replace(serie.guessedName, '').trim()}`).join(' â†’ ')}
          </div>
        `;
        
        serie.books.forEach(book => {
          seriesHTML += `
            <div class="buch-item">
              ${book.cover ? `<img src="${book.cover}" class="buch-cover" alt="Cover">` : ''}
              <div class="buch-details">
                <div class="buch-titel">${book.titel}</div>
                <div class="buch-autor">${book.autoren.join(', ')}</div>
                <div class="buch-jahr">Band ${book.bandNr} â€¢ ${book.jahr}</div>
              </div>
            </div>
          `;
        });
        
        serieElement.innerHTML = seriesHTML;
        ergebnisListe.appendChild(serieElement);
      });
    }

    // Event-Listener fÃ¼r den Serien-Button
    document.getElementById('showSeries').addEventListener('click', () => {
      if (buecher.length === 0) return;
      
      const seriesMap = detectSeries(buecher);
      displaySeries(seriesMap);
      
      // Button-Zustand aktualisieren
      document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('showSeries').classList.add('active');
    });
  </script>
</body>
</html>
