<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BÃ¼cher-Serien Experte</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f8f9fa;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
    }
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    #suchfeld {
      padding: 12px;
      width: 70%;
      max-width: 500px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    #suchbutton {
      padding: 12px 25px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
      transition: background 0.3s;
    }
    #suchbutton:hover {
      background: #218838;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .sort-btn {
      padding: 10px 20px;
      background: #e9ecef;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .sort-btn.active {
      background: #3498db;
      color: white;
    }
    #buecherListe {
      list-style: none;
      padding: 0;
    }
    .serien-gruppe {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    .serien-header {
      background: #3498db;
      color: white;
      padding: 12px 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .serien-titel {
      font-weight: bold;
      font-size: 1.1em;
    }
    .serien-info {
      font-size: 0.9em;
      opacity: 0.8;
    }
    .lese-reihenfolge {
      background: #f8f9fa;
      padding: 10px;
      font-size: 0.9em;
      border-bottom: 1px dashed #ddd;
    }
    .buch-item {
      background: white;
      padding: 15px;
      display: flex;
      gap: 15px;
      border-bottom: 1px solid #eee;
    }
    .buch-item:last-child {
      border-bottom: none;
    }
    .buch-cover {
      width: 80px;
      height: auto;
      border-radius: 4px;
    }
    .buch-details {
      flex: 1;
    }
    .buch-titel {
      font-weight: bold;
      margin: 0 0 5px 0;
      color: #2c3e50;
    }
    .buch-autor {
      color: #6c757d;
      margin-bottom: 5px;
    }
    .buch-jahr {
      color: #17a2b8;
      font-size: 0.9em;
    }
    .message {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <h1>ðŸ“š BÃ¼cher-Serien Experte</h1>
  
  <div class="search-box">
    <input type="text" id="suchfeld" placeholder="Autor eingeben (z.B. 'J.K. Rowling')" autocomplete="off">
    <button id="suchbutton" type="button">Suchen</button>
  </div>
  
  <div class="controls">
    <button id="sortNewest" class="sort-btn active">Neueste</button>
    <button id="sortOldest" class="sort-btn">Ã„lteste</button>
    <button id="showSeries" class="sort-btn">Serien anzeigen</button>
  </div>
  
  <ul id="buecherListe">
    <li class="message">Suche nach einem Autor um BÃ¼cher und Serien zu entdecken</li>
  </ul>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elemente
      const suchfeld = document.getElementById('suchfeld');
      const suchbutton = document.getElementById('suchbutton');
      const ergebnisListe = document.getElementById('buecherListe');
      
      // Globale Variablen
      let buecher = [];
      let currentMode = 'newest';

      // Event Listener
      suchbutton.addEventListener('click', sucheBuecher);
      suchfeld.addEventListener('keypress', (e) => e.key === 'Enter' && sucheBuecher());
      document.getElementById('sortNewest').addEventListener('click', () => {
        currentMode = 'newest';
        aktualisiereAnsicht();
        updateActiveButton('sortNewest');
      });
      document.getElementById('sortOldest').addEventListener('click', () => {
        currentMode = 'oldest';
        aktualisiereAnsicht();
        updateActiveButton('sortOldest');
      });
      document.getElementById('showSeries').addEventListener('click', () => {
        currentMode = 'series';
        aktualisiereAnsicht();
        updateActiveButton('showSeries');
      });

      // Hauptfunktionen
      async function sucheBuecher() {
        const autor = suchfeld.value.trim();
        if (autor.length < 2) {
          showMessage('Bitte mindestens 2 Zeichen eingeben');
          return;
        }
        
        showMessage('Suche lÃ¤uft...');
        
        try {
          const response = await fetch(`https://openlibrary.org/search.json?author=${encodeURIComponent(autor)}&limit=100`);
          const daten = await response.json();
          
          buecher = daten.docs
            .filter(b => b.title && b.first_publish_year)
            .map(b => ({
              titel: b.title,
              autoren: b.author_name || ['Unbekannt'],
              jahr: b.first_publish_year,
              cover: b.cover_i ? `https://covers.openlibrary.org/b/id/${b.cover_i}-M.jpg` : null
            }));
          
          if (buecher.length === 0) {
            showMessage('Keine BÃ¼cher gefunden');
            return;
          }
          
          aktualisiereAnsicht();
          
        } catch (error) {
          console.error('Fehler:', error);
          showMessage('Fehler bei der Suche');
        }
      }

      function aktualisiereAnsicht() {
        if (currentMode === 'series') {
          zeigeSerienAnsicht();
        } else {
          zeigeStandardAnsicht();
        }
      }

      function zeigeStandardAnsicht() {
        const sortierteBuecher = [...buecher].sort((a, b) => 
          currentMode === 'newest' ? b.jahr - a.jahr : a.jahr - b.jahr
        );
        
        ergebnisListe.innerHTML = sortierteBuecher.map(buch => `
          <li class="buch-item">
            ${buch.cover ? `<img src="${buch.cover}" class="buch-cover" alt="Cover">` : ''}
            <div class="buch-details">
              <div class="buch-titel">${buch.titel}</div>
              <div class="buch-autor">${buch.autoren.join(', ')}</div>
              <div class="buch-jahr">${buch.jahr}</div>
            </div>
          </li>
        `).join('');
      }

      function zeigeSerienAnsicht() {
        const serienMap = detectSeries(buecher);
        
        if (Object.keys(serienMap).length === 0) {
          ergebnisListe.innerHTML = '<li class="message">Keine Serien gefunden</li>';
          return;
        }
        
        let html = '';
        
        Object.entries(serienMap).forEach(([serieKey, serie]) => {
          html += `
            <li class="serien-gruppe">
              <div class="serien-header">
                <span class="serien-titel">${serie.name}</span>
                <span class="serien-info">${serie.books.length} BÃ¼cher</span>
              </div>
              <div class="lese-reihenfolge">
                ðŸ’¡ Lesereihenfolge: ${serie.books.map((b, i) => `${i+1}. ${b.titel.replace(serie.name, '').trim()}`).join(' â†’ ')}
              </div>
              ${serie.books.map(buch => `
                <div class="buch-item">
                  ${buch.cover ? `<img src="${buch.cover}" class="buch-cover" alt="Cover">` : ''}
                  <div class="buch-details">
                    <div class="buch-titel">${buch.titel}</div>
                    <div class="buch-autor">${buch.autoren.join(', ')}</div>
                    <div class="buch-jahr">${buch.jahr}</div>
                  </div>
                </div>
              `).join('')}
            </li>
          `;
        });
        
        ergebnisListe.innerHTML = html;
      }

      function detectSeries(books) {
        const seriesMap = {};
        
        books.forEach(book => {
          const serieInfo = extractSeriesInfo(book.titel);
          const serieKey = serieInfo ? serieInfo.name : 'EinzelbÃ¤nde';
          const bandNr = serieInfo ? serieInfo.number : 0;
          
          if (!seriesMap[serieKey]) {
            seriesMap[serieKey] = {
              name: serieKey,
              books: []
            };
          }
          
          seriesMap[serieKey].books.push({
            ...book,
            bandNr: bandNr
          });
        });
        
        // Sortiere BÃ¼cher innerhalb der Serien
        Object.values(seriesMap).forEach(serie => {
          serie.books.sort((a, b) => a.bandNr - b.bandNr);
          
          // Verbessere Seriennamen
          if (serie.name !== 'EinzelbÃ¤nde') {
            const commonPrefix = findCommonPrefix(serie.books.map(b => b.titel));
            if (commonPrefix.length > 10) {
              serie.name = commonPrefix;
            }
          }
        });
        
        // Entferne "EinzelbÃ¤nde" wenn leer
        if (seriesMap['EinzelbÃ¤nde'] && seriesMap['EinzelbÃ¤nde'].books.length === 0) {
          delete seriesMap['EinzelbÃ¤nde'];
        }
        
        return seriesMap;
      }

      function extractSeriesInfo(title) {
        const patterns = [
          /^(.*?)\s*\(Band\s*(\d+)\)/i,
          /^(.*?)\s*[,-]\s*Band\s*(\d+)/i,
          /^(.*?)\s*Bd\.\s*(\d+)/i,
          /^(.*?)\s*#(\d+)/i,
          /^(.*?)\s*Teil\s*(\d+)/i,
          /^(.*?)\s*Vol\.\s*(\d+)/i
        ];
        
        for (const pattern of patterns) {
          const match = title.match(pattern);
          if (match) {
            return {
              name: match[1].trim(),
              number: parseInt(match[2])
            };
          }
        }
        return null;
      }

      function findCommonPrefix(titles) {
        if (titles.length === 0) return '';
        let prefix = titles[0];
        for (let i = 1; i < titles.length; i++) {
          while (titles[i].indexOf(prefix) !== 0) {
            prefix = prefix.substring(0, prefix.length - 1);
            if (prefix === '') return '';
          }
        }
        return prefix;
      }

      function updateActiveButton(activeId) {
        document.querySelectorAll('.sort-btn').forEach(btn => {
          btn.classList.toggle('active', btn.id === activeId);
        });
      }

      function showMessage(text) {
        ergebnisListe.innerHTML = `<li class="message">${text}</li>`;
      }
    });
  </script>
</body>
</html>
